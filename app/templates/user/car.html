<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´­ç‰©è½¦ - æˆ·å¤–å•†å“å•†åŸ</title>
    <link rel="icon" type="image/png" sizes="16x16" href="../../static/icons/favicon.svg">
    <link rel="stylesheet" href="{{ url_for('static', filename='navbar.css') }}">
    <style>
        /* è´­ç‰©è½¦é¡µé¢ç‰¹æœ‰æ ·å¼ */
        .cart-container {
            padding: 40px 0;
            min-height: 500px;
        }

        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
        }

        .cart-title {
            font-size: 28px;
            color: #333;
            font-weight: 600;
        }

        .cart-stats {
            color: #666;
            font-size: 16px;
        }

        .cart-items {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .cart-item {
            display: grid;
            grid-template-columns: 100px 2fr 1fr 1fr auto;
            gap: 20px;
            align-items: center;
            padding: 25px;
            transition: all 0.3s;
        }

        .cart-item:hover {
            background: #f8f9fa;
        }

        .item-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .item-info {
            padding-right: 20px;
        }

        .item-name {
            font-size: 18px;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .item-brand {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .item-price {
            color: #ff6b6b;
            font-weight: bold;
            font-size: 16px;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s;
        }

        .quantity-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .quantity-input {
            width: 60px;
            text-align: center;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .item-total {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .item-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .action-btn.delete {
            background: #ff6b6b;
            color: white;
        }

        .action-btn.delete:hover {
            background: #ff4757;
        }

        .cart-empty {
            text-align: center;
            padding: 80px 20px;
            color: #666;
        }

        .cart-empty-icon {
            font-size: 60px;
            color: #ddd;
            margin-bottom: 20px;
        }

        .cart-empty h3 {
            font-size: 24px;
            margin-bottom: 15px;
            color: #333;
        }

        .cart-summary {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-top: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
        }

        .summary-row:last-child {
            font-weight: bold;
            font-size: 20px;
            color: #333;
        }

        .summary-value {
            font-weight: 500;
        }

        .summary-total {
            color: #ff6b6b;
        }

        .checkout-section {
            text-align: right;
            margin-top: 30px;
        }

        .checkout-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 18px 40px;
            font-size: 18px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .checkout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(245, 87, 108, 0.4);
        }

        .continue-shopping {
            color: #667eea;
            text-decoration: none;
            margin-right: 20px;
            font-size: 16px;
            transition: color 0.3s;
        }

        .continue-shopping:hover {
            color: #5a67d8;
        }

        /* æ¨èå•†å“ */
        .recommendations {
            margin-top: 60px;
        }

        .recommendations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .recommendation-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .recommendation-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }

        .recommendation-image {
            width: 100%;
            height: 160px;
            object-fit: cover;
        }

        .recommendation-info {
            padding: 15px;
        }

        .recommendation-name {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .recommendation-card a,
        .recommendation-card a:hover {
            text-decoration: none;
            color: inherit;
        }

        .recommendation-price {
            color: #ff6b6b;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
        }

        .add-to-cart-small {
            width: 100%;
            padding: 8px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .add-to-cart-small:hover {
            background: #5a67d8;
        }

        /* ä»˜æ¬¾ç¡®è®¤å¼¹çª—æ ·å¼ */
        .payment-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 9999;
            animation: fadeIn 0.3s ease;
        }

        .payment-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .payment-modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .payment-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            border-bottom: 1px solid #eee;
        }

        .payment-modal-header h2 {
            font-size: 24px;
            color: #333;
            font-weight: 600;
            margin: 0;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 32px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .close-modal:hover {
            color: #333;
            transform: rotate(90deg);
        }

        .payment-modal-body {
            padding: 30px;
        }

        .payment-summary {
            margin-bottom: 20px;
        }

        .payment-summary-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            font-size: 16px;
            color: #666;
        }

        .payment-summary-row.total {
            border-top: 2px solid #eee;
            padding-top: 20px;
            margin-top: 10px;
            font-weight: 600;
            font-size: 20px;
            color: #333;
        }

        .payment-summary-row.total span:last-child {
            color: #ff6b6b;
            font-size: 28px;
        }

        .payment-tips {
            background: #f0f4ff;
            padding: 15px 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .payment-tips p {
            margin: 0;
            color: #667eea;
            font-size: 14px;
        }

        .payment-modal-footer {
            display: flex;
            gap: 15px;
            padding: 20px 30px;
            background: #f8f9fa;
            border-radius: 0 0 20px 20px;
        }

        .payment-btn {
            flex: 1;
            padding: 15px 20px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .back-btn {
            background: #e0e0e0;
            color: #666;
        }

        .back-btn:hover {
            background: #d0d0d0;
        }

        .cancel-btn {
            background: #ff6b6b;
            color: white;
        }

        .cancel-btn:hover {
            background: #ff4757;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }

        .confirm-btn {
            background: linear-gradient(135deg, #28b779 0%, #34d399 100%);
            color: white;
        }

        .confirm-btn:hover {
            background: linear-gradient(135deg, #20a069 0%, #28b779 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 183, 121, 0.3);
        }

        @media (max-width: 768px) {
            .cart-item {
                grid-template-columns: 1fr;
                text-align: center;
                gap: 15px;
            }

            .item-image {
                margin: 0 auto;
            }

            .quantity-control {
                justify-content: center;
            }

            .item-actions {
                justify-content: center;
            }

            .checkout-section {
                text-align: center;
            }
        }
    </style>
</head>
<body>
<!-- å¯¼èˆªæ  -->
<header class="header">
    <div class="w">
        <a class="logo" href="{{ url_for('user.index') }}">
            <span class="logo-text">Store</span>
        </a>
        <nav class="nav">
            <ul class="nav-list">
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('user.index') }}">é¦–é¡µ</a>
                </li>
                <li class="nav-item {% if request.endpoint == 'user.car' %}active{% endif %}">
                    <a class="nav-link" href="{{ url_for('user.car') }}">è´­ç‰©è½¦</a>
                </li>
                <li class="nav-item {% if request.endpoint == 'user.personal_center' %}active{% endif %}">
                    <a class="nav-link" href="{{ url_for('user.personal_center') }}">ä¸ªäººä¸­å¿ƒ</a>
                </li>
                <li class="nav-item {% if request.endpoint == 'user.about' %}active{% endif %}">
                    <a class="nav-link" href="{{ url_for('user.about') }}">å…¨éƒ¨å•†å“</a>
                </li>
                <li class="nav-item search-item">
                    <form class="search-form" action="{{ url_for('user.search') }}" method="GET">
                        <input class="search-input-sm" type="text" name="keyword" placeholder="æœç´¢å•†å“..." value="{{ request.args.get('keyword', '') }}">
                        <button class="search-btn-sm" type="submit">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                        </button>
                    </form>
                </li>
                <li class="nav-item">
                    {% if user %}
                    <div class="user-info">
                        <span class="user-name">æ¬¢è¿ï¼Œ{{ user.name }}</span>
                        <a href="{{ url_for('user.logout') }}" class="logout-btn">é€€å‡º</a>
                    </div>
                    {% endif %}
                </li>
            </ul>
        </nav>
    </div>
</header>

<!-- è´­ç‰©è½¦å†…å®¹ -->
<div class="w cart-container">
    <div class="page-header">
        <h1 class="page-title">æˆ‘çš„è´­ç‰©è½¦</h1>
        {% if products %}
        <div class="page-subtitle">å…± {{ products|length }} ä»¶å•†å“</div>
        {% endif %}
    </div>

    {% if products %}
    <div class="cart-items">
        {% for cart_item in products %}
        <div class="cart-item" data-id="{{ cart_item.item_id }}">
            <!-- å•†å“å›¾ç‰‡ -->
            <img src="{{ cart_item.product.photo }}" alt="{{ cart_item.product.name }}" class="item-image">

            <!-- å•†å“ä¿¡æ¯ -->
            <div class="item-info">
                <h3 class="item-name">{{ cart_item.product.name }}</h3>
                <div class="item-brand">å“ç‰Œï¼š{{ cart_item.product.derive }}</div>
                <div class="item-price">Â¥{{ cart_item.product.price }}</div>
            </div>

            <!-- æ•°é‡æ§åˆ¶ -->
            <div class="quantity-control">
                <button class="quantity-btn decrease" data-id="{{ cart_item.item_id }}">-</button>
                <input type="number" class="quantity-input" value="{{ cart_item.number }}" min="1" max="99" data-id="{{ cart_item.item_id }}">
                <button class="quantity-btn increase" data-id="{{ cart_item.item_id }}">+</button>
            </div>

            <!-- å°è®¡ -->
            <div class="item-total" id="total-{{ cart_item.item_id }}"
                 data-price="{{ cart_item.product.price }}"
                 data-quantity="{{ cart_item.number }}">
                Â¥{{ (cart_item.number * cart_item.product.price)|round(2) }}
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="item-actions">
                <button class="action-btn delete" data-id="{{ cart_item.item_id }}">åˆ é™¤</button>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- è´­ç‰©è½¦æ€»ç»“ -->
    <div class="cart-summary">
        <div class="summary-row">
            <span>å•†å“æ€»ä»·ï¼š</span>
            <span class="summary-value" id="subtotal">Â¥{{ total_price }}</span>
        </div>
        <div class="summary-row">
            <span>è¿è´¹ï¼š</span>
            <span class="summary-value">Â¥0.00</span>
        </div>
        <div class="summary-row">
            <span>ä¼˜æƒ åˆ¸ï¼š</span>
            <span class="summary-value">-Â¥0.00</span>
        </div>
        <div class="summary-row">
            <span>å®ä»˜é‡‘é¢ï¼š</span>
            <span class="summary-value summary-total" id="grand-total">Â¥{{ total_price }}</span>
        </div>
    </div>

    <!-- ç»“ç®—æŒ‰é’® -->
    <div class="checkout-section">
        <a href="{{ url_for('user.index') }}" class="continue-shopping">ç»§ç»­è´­ç‰©</a>
        <button class="checkout-btn" onclick="showPaymentModal()">
            <span>å»ç»“ç®—</span>
            <span id="checkout-total">Â¥{{ total_price }}</span>
        </button>
    </div>

    <!-- ä»˜æ¬¾ç¡®è®¤å¼¹çª— -->
    <div id="payment-modal" class="payment-modal">
        <div class="payment-modal-content">
            <div class="payment-modal-header">
                <h2>ç¡®è®¤ä»˜æ¬¾</h2>
                <button class="close-modal" onclick="closePaymentModal()">&times;</button>
            </div>

            <div class="payment-modal-body">
                <div class="payment-summary">
                    <div class="payment-summary-row">
                        <span>å•†å“æ€»ä»·ï¼š</span>
                        <span id="modal-subtotal">Â¥{{ total_price }}</span>
                    </div>
                    <div class="payment-summary-row">
                        <span>è¿è´¹ï¼š</span>
                        <span>Â¥0.00</span>
                    </div>
                    <div class="payment-summary-row total">
                        <span>åº”ä»˜é‡‘é¢ï¼š</span>
                        <span id="modal-total">Â¥{{ total_price }}</span>
                    </div>
                </div>

                <div class="payment-tips">
                    <p>ğŸ’¡ è¯·ç¡®è®¤æ‚¨çš„è®¢å•ä¿¡æ¯</p>
                </div>
            </div>

            <div class="payment-modal-footer">
                <button class="payment-btn back-btn" onclick="closePaymentModal()">è¿”å›</button>
                <button class="payment-btn cancel-btn" onclick="cancelPayment()">å–æ¶ˆä»˜æ¬¾</button>
                <button class="payment-btn confirm-btn" onclick="confirmPayment()">ç¡®è®¤ä»˜æ¬¾</button>
            </div>
        </div>
    </div>

    <script>
        // ========== ä»˜æ¬¾ç›¸å…³å‡½æ•° ==========
        // ä½¿ç”¨ç«‹å³æ‰§è¡Œå‡½æ•°ç¡®ä¿å‡½æ•°å®šä¹‰
        (function() {
            // æ˜¾ç¤ºä»˜æ¬¾ç¡®è®¤å¼¹çª—
            window.showPaymentModal = function() {
                console.log('showPaymentModal called');
                const modal = document.getElementById('payment-modal');

                if (!modal) {
                    console.error('payment-modal element not found!');
                    alert('å¼¹çª—å…ƒç´ æœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                    return false;
                }

                const modalSubtotal = document.getElementById('modal-subtotal');
                const modalTotal = document.getElementById('modal-total');
                const grandTotal = document.getElementById('grand-total');

                if (!grandTotal) {
                    console.error('grand-total element not found!');
                    alert('ä»·æ ¼å…ƒç´ æœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                    return false;
                }

                const currentTotal = grandTotal.textContent;

                // æ›´æ–°å¼¹çª—ä¸­çš„ä»·æ ¼
                if (modalSubtotal) modalSubtotal.textContent = currentTotal;
                if (modalTotal) modalTotal.textContent = currentTotal;

                // æ˜¾ç¤ºå¼¹çª—
                modal.classList.add('active');
                console.log('Modal displayed successfully');
                return false;
            };

            // å…³é—­ä»˜æ¬¾ç¡®è®¤å¼¹çª—
            window.closePaymentModal = function() {
                const modal = document.getElementById('payment-modal');
                if (modal) {
                    modal.classList.remove('active');
                }
                return false;
            };

            // å–æ¶ˆä»˜æ¬¾
            window.cancelPayment = function() {
                if (confirm('ç¡®å®šè¦å–æ¶ˆä»˜æ¬¾å—ï¼Ÿè´­ç‰©è½¦ä¸­çš„å•†å“å°†ä¿å­˜ä¸ºå·²å–æ¶ˆè®¢å•ã€‚')) {
                    fetch('/create_order?status=cancelled', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            closePaymentModal();
                            alert('è®¢å•å·²å–æ¶ˆï¼Œå·²ä¿å­˜åˆ°æ‚¨çš„è®¢å•ä¸­');
                            window.location.href = '/personal_center';
                        } else {
                            alert(data.message || 'æ“ä½œå¤±è´¥');
                        }
                    })
                    .catch(error => {
                        console.error('å–æ¶ˆä»˜æ¬¾å¤±è´¥:', error);
                        alert('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    });
                }
                return false;
            };

            // ç¡®è®¤ä»˜æ¬¾
            window.confirmPayment = function() {
                const confirmBtn = document.querySelector('.confirm-btn');
                const originalText = confirmBtn.textContent;
                confirmBtn.textContent = 'å¤„ç†ä¸­...';
                confirmBtn.disabled = true;

                fetch('/create_order?status=paid', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        closePaymentModal();
                        alert('ä»˜æ¬¾æˆåŠŸï¼æ„Ÿè°¢æ‚¨çš„è´­ä¹°');
                        window.location.href = '/personal_center';
                    } else {
                        alert(data.message || 'ä»˜æ¬¾å¤±è´¥');
                        confirmBtn.textContent = originalText;
                        confirmBtn.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('ä»˜æ¬¾å¤±è´¥:', error);
                    alert('ä»˜æ¬¾å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    confirmBtn.textContent = originalText;
                    confirmBtn.disabled = false;
                });
                return false;
            };

            console.log('Payment functions loaded successfully');
        })();
    </script>

    {% else %}
    <!-- ç©ºè´­ç‰©è½¦ -->
    <div class="cart-empty">
        <div class="cart-empty-icon">ğŸ›’</div>
        <h3>è´­ç‰©è½¦ç©ºç©ºå¦‚ä¹Ÿ</h3>
        <p style="color: #999; margin-bottom: 30px; max-width: 400px; margin: 0 auto 30px;">
            æ‚¨è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•å•†å“åˆ°è´­ç‰©è½¦ï¼Œå¿«å»æŒ‘é€‰å¿ƒä»ªçš„å•†å“å§ï¼
        </p>
        <a href="{{ url_for('user.index') }}" class="btn" style="display: inline-block;">
            å»é¦–é¡µé€›é€›
        </a>
    </div>
    {% endif %}

    <!-- åœ¨ car.html ä¸­æ‰¾åˆ°æ¨èå•†å“éƒ¨åˆ†ï¼Œä¿®æ”¹ä¸ºï¼š -->
{% if products %}
<!-- æ¨èå•†å“ -->
<div class="recommendations">
    <h2 class="section-title" style="font-size: 24px; border-bottom: none; text-align: center; margin-bottom: 30px;">
        çŒœä½ å–œæ¬¢
    </h2>
    <div class="recommendations-grid">
        {% if random_products %}
            {% for rec_product in random_products %}
            <div class="recommendation-card">
                <a href="{{ url_for('user.detail', id=rec_product.id) }}">
                    <img src="{{ rec_product.photo }}" alt="{{ rec_product.name }}" class="recommendation-image">
                    <div class="recommendation-info">
                        <h3 class="recommendation-name">{{ rec_product.name }}</h3>
                        <div class="recommendation-price">Â¥{{ rec_product.price }}</div>
                        <div style="font-size: 12px; color: #999; margin-bottom: 12px;">å“ç‰Œï¼š{{ rec_product.derive }}</div>
                        <button class="add-to-cart-small" data-id="{{ rec_product.id }}">åŠ å…¥è´­ç‰©è½¦</button>
                    </div>
                </a>
            </div>
            {% endfor %}
        {% else %}
            <!-- å¦‚æœæ²¡æœ‰æ¨èå•†å“ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯ -->
            <div style="text-align: center; grid-column: 1 / -1; padding: 40px; color: #999;">
                æš‚æ— ç›¸å…³æ¨èå•†å“
            </div>
        {% endif %}
    </div>
</div>
{% endif %}
</div>

<!-- é¡µè„š -->
<footer class="footer">
    <div class="footer-content">
        <div class="footer-section">
            <h3>å…³äºæˆ‘ä»¬</h3>
            <p style="color: #ddd; line-height: 1.8; margin-top: 15px;">
                æˆ‘ä»¬è‡´åŠ›äºä¸ºæˆ·å¤–çˆ±å¥½è€…æä¾›æœ€ä¼˜è´¨çš„è£…å¤‡å’ŒæœåŠ¡ï¼Œè®©æ‚¨çš„æˆ·å¤–ä¹‹æ—…æ›´åŠ ç²¾å½©ã€‚
            </p>
        </div>

        <div class="footer-section">
            <h3>è´­ç‰©æŒ‡å—</h3>
            <ul class="footer-links">
                <li><a href="#">è´­ç‰©æµç¨‹</a></li>
                <li><a href="#">ä¼šå‘˜ä»‹ç»</a></li>
                <li><a href="#">å¸¸è§é—®é¢˜</a></li>
                <li><a href="#">è”ç³»å®¢æœ</a></li>
            </ul>
        </div>

        <div class="footer-section">
            <h3>æ”¯ä»˜æ–¹å¼</h3>
            <p style="color: #ddd; line-height: 1.8; margin-top: 15px;">
                æ”¯æŒæ”¯ä»˜å®ã€å¾®ä¿¡æ”¯ä»˜ã€é“¶è¡Œå¡ç­‰å¤šç§æ”¯ä»˜æ–¹å¼
            </p>
        </div>

        <div class="footer-section">
            <h3>å”®åæœåŠ¡</h3>
            <ul class="footer-links">
                <li><a href="#">é€€æ¢è´§æ”¿ç­–</a></li>
                <li><a href="#">å”®åä¿éšœ</a></li>
                <li><a href="#">æŠ•è¯‰å»ºè®®</a></li>
            </ul>
        </div>
    </div>

    <div class="copyright">
        <p>æˆ·å¤–å•†å“å•†åŸ &copy; 2024 ç‰ˆæƒæ‰€æœ‰</p>
    </div>
</footer>

<script>
    // ========== è´­ç‰©è½¦æ“ä½œå‡½æ•° ==========
    function updateCartItem(itemId, newQuantity) {
        // è·å–å•†å“ä»·æ ¼
        const totalElement = document.getElementById(`total-${itemId}`);
        const price = parseFloat(totalElement.dataset.price);
        const total = price * newQuantity;
        totalElement.textContent = `Â¥${total.toFixed(2)}`;
        totalElement.dataset.quantity = newQuantity;

        // é‡æ–°è®¡ç®—æ€»ä»·
        calculateTotal();

        // å‘é€è¯·æ±‚åˆ°æœåŠ¡å™¨æ›´æ–°æ•°é‡
        fetch('/update_car/' + itemId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ quantity: newQuantity })
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                console.error('æ›´æ–°æ•°é‡å¤±è´¥:', data.message);
            }
        })
        .catch(error => {
            console.error('æ›´æ–°æ•°é‡å¤±è´¥:', error);
        });
    }

    // è®¡ç®—è´­ç‰©è½¦æ€»ä»·
    function calculateTotal() {
        let subtotal = 0;
        document.querySelectorAll('.item-total').forEach(element => {
            const price = parseFloat(element.dataset.price);
            const quantity = parseInt(element.dataset.quantity);
            subtotal += price * quantity;
        });

        const formattedTotal = `Â¥${subtotal.toFixed(2)}`;
        document.getElementById('subtotal').textContent = formattedTotal;
        document.getElementById('grand-total').textContent = formattedTotal;

        // åŒæ—¶æ›´æ–°ç»“ç®—æŒ‰é’®ä¸­çš„ä»·æ ¼
        const checkoutTotal = document.getElementById('checkout-total');
        if (checkoutTotal) {
            checkoutTotal.textContent = formattedTotal;
        }
    }

    // åˆ é™¤è´­ç‰©è½¦å•†å“
    function deleteCartItem(itemId) {
        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå•†å“å—ï¼Ÿ')) {
            // è·å–å½“å‰å•†å“çš„æ•°é‡å’Œä»·æ ¼ï¼Œå…ˆä»å‰ç«¯ç§»é™¤
            const itemElement = document.querySelector(`.cart-item[data-id="${itemId}"]`);
            if (itemElement) {
                itemElement.remove();
                // ç«‹å³é‡æ–°è®¡ç®—æ€»ä»·
                calculateTotal();
            }

            // å‘é€AJAXè¯·æ±‚åˆ°æœåŠ¡å™¨åˆ é™¤å•†å“
            fetch('/remove_car/' + itemId, {
                method: 'GET',
                headers: {
                    'Cache-Control': 'no-cache'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('åˆ é™¤å¤±è´¥');
                }
                return response.json();
            })
            .then(data => {
                if (!data.success) {
                    alert(data.message || 'åˆ é™¤å¤±è´¥');
                    // å¦‚æœåˆ é™¤å¤±è´¥ï¼Œé‡æ–°åŠ è½½é¡µé¢æ¢å¤çŠ¶æ€
                    location.reload();
                } else {
                    // åˆ é™¤æˆåŠŸï¼Œæ£€æŸ¥è´­ç‰©è½¦æ˜¯å¦ä¸ºç©º
                    if (document.querySelectorAll('.cart-item').length === 0) {
                        location.reload();
                    }
                }
            })
            .catch(error => {
                console.error('åˆ é™¤å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ï¼');
                location.reload();
            });
        }
    }

    // äº‹ä»¶ç›‘å¬
    document.addEventListener('DOMContentLoaded', function() {
        // ç»“ç®—æŒ‰é’® - æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ä½œä¸ºå¤‡ä»½
        const checkoutBtn = document.querySelector('.checkout-btn');
        if (checkoutBtn) {
            checkoutBtn.addEventListener('click', function(e) {
                console.log('Checkout button clicked via event listener');
                e.preventDefault();
                showPaymentModal();
            });
        }

        // æ•°é‡å‡å°‘æŒ‰é’®
        document.querySelectorAll('.decrease').forEach(button => {
            button.addEventListener('click', function() {
                const itemId = this.dataset.id;
                const input = document.querySelector(`.quantity-input[data-id="${itemId}"]`);
                let value = parseInt(input.value);
                if (value > 1) {
                    input.value = value - 1;
                    updateCartItem(itemId, value - 1);
                }
            });
        });

        // æ•°é‡å¢åŠ æŒ‰é’®
        document.querySelectorAll('.increase').forEach(button => {
            button.addEventListener('click', function() {
                const itemId = this.dataset.id;
                const input = document.querySelector(`.quantity-input[data-id="${itemId}"]`);
                let value = parseInt(input.value);
                if (value < 99) {
                    input.value = value + 1;
                    updateCartItem(itemId, value + 1);
                }
            });
        });

        // æ•°é‡è¾“å…¥æ¡†å˜åŒ–
        document.querySelectorAll('.quantity-input').forEach(input => {
            input.addEventListener('change', function() {
                const itemId = this.dataset.id;
                let value = parseInt(this.value);
                if (value < 1) value = 1;
                if (value > 99) value = 99;
                this.value = value;
                updateCartItem(itemId, value);
            });
        });

        // åˆ é™¤æŒ‰é’®
        document.querySelectorAll('.action-btn.delete').forEach(button => {
            button.addEventListener('click', function() {
                const itemId = this.dataset.id;
                deleteCartItem(itemId);
            });
        });

        // æ¨èå•†å“åŠ å…¥è´­ç‰©è½¦æŒ‰é’®
        document.querySelectorAll('.add-to-cart-small').forEach(button => {
            button.addEventListener('click', function(event) {
                event.preventDefault();
                event.stopPropagation();
                const productId = this.dataset.id;

                // å‘é€AJAXè¯·æ±‚å°†å•†å“åŠ å…¥è´­ç‰©è½¦
                fetch('/add_car/' + productId + '?ajax=1', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // æ˜¾ç¤ºåŠ å…¥æˆåŠŸæç¤º
                        const originalText = this.textContent;
                        this.textContent = 'å·²åŠ å…¥';
                        this.style.background = '#28a745';

                        setTimeout(() => {
                            this.textContent = originalText;
                            this.style.background = '#667eea';
                        }, 2000);

                        // åˆ·æ–°é¡µé¢ä»¥æ›´æ–°è´­ç‰©è½¦æ˜¾ç¤ºå’Œä»·æ ¼
                        setTimeout(() => {
                            location.reload();
                        }, 500);
                    } else {
                        alert(data.message || 'åŠ å…¥å¤±è´¥');
                    }
                })
                .catch(error => {
                    console.error('åŠ å…¥è´­ç‰©è½¦å¤±è´¥:', error);
                });
            });
        });
    }

</script>
</body>
</html>